-- All programs A380 + A400M : Checksum compute

if exists (select * from dbo.sysobjects where id = object_id(N'[dbo].[fn_CalculCRC32]') /*and OBJECTPROPERTY(id, N'IsInLineFunction') = 1 */ )
drop function [dbo].[fn_CalculCRC32]
GO

CREATE FUNCTION dbo.fn_CalculCRC32 (@String VARCHAR(8000))
RETURNS VARCHAR(8000) AS
BEGIN

	DECLARE
		-- var to compute CRC32
		@crc32Result INT,
		-- indice for the Hash table
		@iLookup INT,
		-- Var containing ascii value
		@int_CurrentDataByte INT,
		@strWork VARCHAR(8000),
		@i INT,
		@R BIGINT,
		@B BIGINT,
		@H7 VARCHAR(8000),
		@H6 VARCHAR(8000),
		@H5 VARCHAR(8000),
		@H4 VARCHAR(8000),
		@H3 VARCHAR(8000),
		@H2 VARCHAR(8000),
		@H1 VARCHAR(8000),
		@H0 VARCHAR(8000)

	-- intialize the CRC32
	SET @crc32Result = 0xFFFFFFFF

	SET @i = 1

	-- For each character, compute with the previous CRC32
	WHILE @i <= LEN(@String)
	BEGIN
		SET @int_CurrentDataByte = ASCII(SUBSTRING(@String, @i, 1))
		SET @iLookup = (@crc32Result & 0xFF) ^ @int_CurrentDataByte
		SET @crc32Result = ((@crc32Result & 0xFFFFFF00) / 0x100) & 0xFFFFFF
		SET @crc32Result = @crc32Result ^ 
			CASE @iLookup
				WHEN 0 THEN 0x0
				WHEN 1 THEN 0x77073096
				WHEN 2 THEN 0xEE0E612C
				WHEN 3 THEN 0x990951BA
				WHEN 4 THEN 0x76DC419
				WHEN 5 THEN 0x706AF48F
				WHEN 6 THEN 0xE963A535
				WHEN 7 THEN 0x9E6495A3
				WHEN 8 THEN 0xEDB8832
				WHEN 9 THEN 0x79DCB8A4
				WHEN 10 THEN 0xE0D5E91E
				WHEN 11 THEN 0x97D2D988
				WHEN 12 THEN 0x9B64C2B
				WHEN 13 THEN 0x7EB17CBD
				WHEN 14 THEN 0xE7B82D07
				WHEN 15 THEN 0x90BF1D91
				WHEN 16 THEN 0x1DB71064
				WHEN 17 THEN 0x6AB020F2
				WHEN 18 THEN 0xF3B97148
				WHEN 19 THEN 0x84BE41DE
				WHEN 20 THEN 0x1ADAD47D
				WHEN 21 THEN 0x6DDDE4EB
				WHEN 22 THEN 0xF4D4B551
				WHEN 23 THEN 0x83D385C7
				WHEN 24 THEN 0x136C9856
				WHEN 25 THEN 0x646BA8C0
				WHEN 26 THEN 0xFD62F97A
				WHEN 27 THEN 0x8A65C9EC
				WHEN 28 THEN 0x14015C4F
				WHEN 29 THEN 0x63066CD9
				WHEN 30 THEN 0xFA0F3D63
				WHEN 31 THEN 0x8D080DF5
				WHEN 32 THEN 0x3B6E20C8
				WHEN 33 THEN 0x4C69105E
				WHEN 34 THEN 0xD56041E4
				WHEN 35 THEN 0xA2677172
				WHEN 36 THEN 0x3C03E4D1
				WHEN 37 THEN 0x4B04D447
				WHEN 38 THEN 0xD20D85FD
				WHEN 39 THEN 0xA50AB56B
				WHEN 40 THEN 0x35B5A8FA
				WHEN 41 THEN 0x42B2986C
				WHEN 42 THEN 0xDBBBC9D6
				WHEN 43 THEN 0xACBCF940
				WHEN 44 THEN 0x32D86CE3
				WHEN 45 THEN 0x45DF5C75
				WHEN 46 THEN 0xDCD60DCF
				WHEN 47 THEN 0xABD13D59
				WHEN 48 THEN 0x26D930AC
				WHEN 49 THEN 0x51DE003A
				WHEN 50 THEN 0xC8D75180
				WHEN 51 THEN 0xBFD06116
				WHEN 52 THEN 0x21B4F4B5
				WHEN 53 THEN 0x56B3C423
				WHEN 54 THEN 0xCFBA9599
				WHEN 55 THEN 0xB8BDA50F
				WHEN 56 THEN 0x2802B89E
				WHEN 57 THEN 0x5F058808
				WHEN 58 THEN 0xC60CD9B2
				WHEN 59 THEN 0xB10BE924
				WHEN 60 THEN 0x2F6F7C87
				WHEN 61 THEN 0x58684C11
				WHEN 62 THEN 0xC1611DAB
				WHEN 63 THEN 0xB6662D3D
				WHEN 64 THEN 0x76DC4190
				WHEN 65 THEN 0x1DB7106
				WHEN 66 THEN 0x98D220BC
				WHEN 67 THEN 0xEFD5102A
				WHEN 68 THEN 0x71B18589
				WHEN 69 THEN 0x6B6B51F
				WHEN 70 THEN 0x9FBFE4A5
				WHEN 71 THEN 0xE8B8D433
				WHEN 72 THEN 0x7807C9A2
				WHEN 73 THEN 0xF00F934
				WHEN 74 THEN 0x9609A88E
				WHEN 75 THEN 0xE10E9818
				WHEN 76 THEN 0x7F6A0DBB
				WHEN 77 THEN 0x86D3D2D
				WHEN 78 THEN 0x91646C97
				WHEN 79 THEN 0xE6635C01
				WHEN 80 THEN 0x6B6B51F4
				WHEN 81 THEN 0x1C6C6162
				WHEN 82 THEN 0x856530D8
				WHEN 83 THEN 0xF262004E
				WHEN 84 THEN 0x6C0695ED
				WHEN 85 THEN 0x1B01A57B
				WHEN 86 THEN 0x8208F4C1
				WHEN 87 THEN 0xF50FC457
				WHEN 88 THEN 0x65B0D9C6
				WHEN 89 THEN 0x12B7E950
				WHEN 90 THEN 0x8BBEB8EA
				WHEN 91 THEN 0xFCB9887C
				WHEN 92 THEN 0x62DD1DDF
				WHEN 93 THEN 0x15DA2D49
				WHEN 94 THEN 0x8CD37CF3
				WHEN 95 THEN 0xFBD44C65
				WHEN 96 THEN 0x4DB26158
				WHEN 97 THEN 0x3AB551CE
				WHEN 98 THEN 0xA3BC0074
				WHEN 99 THEN 0xD4BB30E2
				WHEN 100 THEN 0x4ADFA541
				WHEN 101 THEN 0x3DD895D7
				WHEN 102 THEN 0xA4D1C46D
				WHEN 103 THEN 0xD3D6F4FB
				WHEN 104 THEN 0x4369E96A
				WHEN 105 THEN 0x346ED9FC
				WHEN 106 THEN 0xAD678846
				WHEN 107 THEN 0xDA60B8D0
				WHEN 108 THEN 0x44042D73
				WHEN 109 THEN 0x33031DE5
				WHEN 110 THEN 0xAA0A4C5F
				WHEN 111 THEN 0xDD0D7CC9
				WHEN 112 THEN 0x5005713C
				WHEN 113 THEN 0x270241AA
				WHEN 114 THEN 0xBE0B1010
				WHEN 115 THEN 0xC90C2086
				WHEN 116 THEN 0x5768B525
				WHEN 117 THEN 0x206F85B3
				WHEN 118 THEN 0xB966D409
				WHEN 119 THEN 0xCE61E49F
				WHEN 120 THEN 0x5EDEF90E
				WHEN 121 THEN 0x29D9C998
				WHEN 122 THEN 0xB0D09822
				WHEN 123 THEN 0xC7D7A8B4
				WHEN 124 THEN 0x59B33D17
				WHEN 125 THEN 0x2EB40D81
				WHEN 126 THEN 0xB7BD5C3B
				WHEN 127 THEN 0xC0BA6CAD
				WHEN 128 THEN 0xEDB88320
				WHEN 129 THEN 0x9ABFB3B6
				WHEN 130 THEN 0x3B6E20C
				WHEN 131 THEN 0x74B1D29A
				WHEN 132 THEN 0xEAD54739
				WHEN 133 THEN 0x9DD277AF
				WHEN 134 THEN 0x4DB2615
				WHEN 135 THEN 0x73DC1683
				WHEN 136 THEN 0xE3630B12
				WHEN 137 THEN 0x94643B84
				WHEN 138 THEN 0xD6D6A3E
				WHEN 139 THEN 0x7A6A5AA8
				WHEN 140 THEN 0xE40ECF0B
				WHEN 141 THEN 0x9309FF9D
				WHEN 142 THEN 0xA00AE27
				WHEN 143 THEN 0x7D079EB1
				WHEN 144 THEN 0xF00F9344
				WHEN 145 THEN 0x8708A3D2
				WHEN 146 THEN 0x1E01F268
				WHEN 147 THEN 0x6906C2FE
				WHEN 148 THEN 0xF762575D
				WHEN 149 THEN 0x806567CB
				WHEN 150 THEN 0x196C3671
				WHEN 151 THEN 0x6E6B06E7
				WHEN 152 THEN 0xFED41B76
				WHEN 153 THEN 0x89D32BE0
				WHEN 154 THEN 0x10DA7A5A
				WHEN 155 THEN 0x67DD4ACC
				WHEN 156 THEN 0xF9B9DF6F
				WHEN 157 THEN 0x8EBEEFF9
				WHEN 158 THEN 0x17B7BE43
				WHEN 159 THEN 0x60B08ED5
				WHEN 160 THEN 0xD6D6A3E8
				WHEN 161 THEN 0xA1D1937E
				WHEN 162 THEN 0x38D8C2C4
				WHEN 163 THEN 0x4FDFF252
				WHEN 164 THEN 0xD1BB67F1
				WHEN 165 THEN 0xA6BC5767
				WHEN 166 THEN 0x3FB506DD
				WHEN 167 THEN 0x48B2364B
				WHEN 168 THEN 0xD80D2BDA
				WHEN 169 THEN 0xAF0A1B4C
				WHEN 170 THEN 0x36034AF6
				WHEN 171 THEN 0x41047A60
				WHEN 172 THEN 0xDF60EFC3
				WHEN 173 THEN 0xA867DF55
				WHEN 174 THEN 0x316E8EEF
				WHEN 175 THEN 0x4669BE79
				WHEN 176 THEN 0xCB61B38C
				WHEN 177 THEN 0xBC66831A
				WHEN 178 THEN 0x256FD2A0
				WHEN 179 THEN 0x5268E236
				WHEN 180 THEN 0xCC0C7795
				WHEN 181 THEN 0xBB0B4703
				WHEN 182 THEN 0x220216B9
				WHEN 183 THEN 0x5505262F
				WHEN 184 THEN 0xC5BA3BBE
				WHEN 185 THEN 0xB2BD0B28
				WHEN 186 THEN 0x2BB45A92
				WHEN 187 THEN 0x5CB36A04
				WHEN 188 THEN 0xC2D7FFA7
				WHEN 189 THEN 0xB5D0CF31
				WHEN 190 THEN 0x2CD99E8B
				WHEN 191 THEN 0x5BDEAE1D
				WHEN 192 THEN 0x9B64C2B0
				WHEN 193 THEN 0xEC63F226
				WHEN 194 THEN 0x756AA39C
				WHEN 195 THEN 0x26D930A
				WHEN 196 THEN 0x9C0906A9
				WHEN 197 THEN 0xEB0E363F
				WHEN 198 THEN 0x72076785
				WHEN 199 THEN 0x5005713
				WHEN 200 THEN 0x95BF4A82
				WHEN 201 THEN 0xE2B87A14
				WHEN 202 THEN 0x7BB12BAE
				WHEN 203 THEN 0xCB61B38
				WHEN 204 THEN 0x92D28E9B
				WHEN 205 THEN 0xE5D5BE0D
				WHEN 206 THEN 0x7CDCEFB7
				WHEN 207 THEN 0xBDBDF21
				WHEN 208 THEN 0x86D3D2D4
				WHEN 209 THEN 0xF1D4E242
				WHEN 210 THEN 0x68DDB3F8
				WHEN 211 THEN 0x1FDA836E
				WHEN 212 THEN 0x81BE16CD
				WHEN 213 THEN 0xF6B9265B
				WHEN 214 THEN 0x6FB077E1
				WHEN 215 THEN 0x18B74777
				WHEN 216 THEN 0x88085AE6
				WHEN 217 THEN 0xFF0F6A70
				WHEN 218 THEN 0x66063BCA
				WHEN 219 THEN 0x11010B5C
				WHEN 220 THEN 0x8F659EFF
				WHEN 221 THEN 0xF862AE69
				WHEN 222 THEN 0x616BFFD3
				WHEN 223 THEN 0x166CCF45
				WHEN 224 THEN 0xA00AE278
				WHEN 225 THEN 0xD70DD2EE
				WHEN 226 THEN 0x4E048354
				WHEN 227 THEN 0x3903B3C2
				WHEN 228 THEN 0xA7672661
				WHEN 229 THEN 0xD06016F7
				WHEN 230 THEN 0x4969474D
				WHEN 231 THEN 0x3E6E77DB
				WHEN 232 THEN 0xAED16A4A
				WHEN 233 THEN 0xD9D65ADC
				WHEN 234 THEN 0x40DF0B66
				WHEN 235 THEN 0x37D83BF0
				WHEN 236 THEN 0xA9BCAE53
				WHEN 237 THEN 0xDEBB9EC5
				WHEN 238 THEN 0x47B2CF7F
				WHEN 239 THEN 0x30B5FFE9
				WHEN 240 THEN 0xBDBDF21C
				WHEN 241 THEN 0xCABAC28A
				WHEN 242 THEN 0x53B39330
				WHEN 243 THEN 0x24B4A3A6
				WHEN 244 THEN 0xBAD03605
				WHEN 245 THEN 0xCDD70693
				WHEN 246 THEN 0x54DE5729
				WHEN 247 THEN 0x23D967BF
				WHEN 248 THEN 0xB3667A2E
				WHEN 249 THEN 0xC4614AB8
				WHEN 250 THEN 0x5D681B02
				WHEN 251 THEN 0x2A6F2B94
				WHEN 252 THEN 0xB40BBE37
				WHEN 253 THEN 0xC30C8EA1
				WHEN 254 THEN 0x5A05DF1B
				WHEN 255 THEN 0x2D02EF8D
			END

		SET @i = @i + 1
	END

	SET @R = ~ @crc32Result
	SET @B = 2
	
	IF @R < 0
		SET @R = POWER(@B, 32) + @R
	
	SELECT @H7 = CASE @R / POWER(@B, 28) WHEN 0 THEN '0' WHEN 1 THEN '1' WHEN 2 THEN '2' WHEN 3 THEN '3' WHEN 4 THEN '4' WHEN 5 THEN '5' WHEN 6 THEN '6' WHEN 7 THEN '7' WHEN 8 THEN '8' WHEN 9 THEN '9' WHEN 10 THEN 'A' WHEN 11 THEN 'B' WHEN 12 THEN 'C' WHEN 13 THEN 'D' WHEN 14 THEN 'E' WHEN 15 THEN 'F' END
	SET @R = @R - (@R / POWER(@B, 28)) * POWER(@B, 28)
	
	SELECT @H6 = CASE @R / POWER(@B, 24) WHEN 0 THEN '0' WHEN 1 THEN '1' WHEN 2 THEN '2' WHEN 3 THEN '3' WHEN 4 THEN '4' WHEN 5 THEN '5' WHEN 6 THEN '6' WHEN 7 THEN '7' WHEN 8 THEN '8' WHEN 9 THEN '9' WHEN 10 THEN 'A' WHEN 11 THEN 'B' WHEN 12 THEN 'C' WHEN 13 THEN 'D' WHEN 14 THEN 'E' WHEN 15 THEN 'F' END
	SET @R = @R - (@R / POWER(@B, 24)) * POWER(@B, 24)
	
	SELECT @H5 = CASE @R / POWER(@B, 20) WHEN 0 THEN '0' WHEN 1 THEN '1' WHEN 2 THEN '2' WHEN 3 THEN '3' WHEN 4 THEN '4' WHEN 5 THEN '5' WHEN 6 THEN '6' WHEN 7 THEN '7' WHEN 8 THEN '8' WHEN 9 THEN '9' WHEN 10 THEN 'A' WHEN 11 THEN 'B' WHEN 12 THEN 'C' WHEN 13 THEN 'D' WHEN 14 THEN 'E' WHEN 15 THEN 'F' END
	SET @R = @R - (@R / POWER(@B, 20)) * POWER(@B, 20)
	
	SELECT @H4 = CASE @R / POWER(@B, 16) WHEN 0 THEN '0' WHEN 1 THEN '1' WHEN 2 THEN '2' WHEN 3 THEN '3' WHEN 4 THEN '4' WHEN 5 THEN '5' WHEN 6 THEN '6' WHEN 7 THEN '7' WHEN 8 THEN '8' WHEN 9 THEN '9' WHEN 10 THEN 'A' WHEN 11 THEN 'B' WHEN 12 THEN 'C' WHEN 13 THEN 'D' WHEN 14 THEN 'E' WHEN 15 THEN 'F' END
	SET @R = @R - (@R / POWER(@B, 16)) * POWER(@B, 16)
	
	SELECT @H3 = CASE @R / POWER(@B, 12) WHEN 0 THEN '0' WHEN 1 THEN '1' WHEN 2 THEN '2' WHEN 3 THEN '3' WHEN 4 THEN '4' WHEN 5 THEN '5' WHEN 6 THEN '6' WHEN 7 THEN '7' WHEN 8 THEN '8' WHEN 9 THEN '9' WHEN 10 THEN 'A' WHEN 11 THEN 'B' WHEN 12 THEN 'C' WHEN 13 THEN 'D' WHEN 14 THEN 'E' WHEN 15 THEN 'F' END
	SET @R = @R - (@R / POWER(@B, 12)) * POWER(@B, 12)
	
	SELECT @H2 = CASE @R / POWER(@B, 8) WHEN 0 THEN '0' WHEN 1 THEN '1' WHEN 2 THEN '2' WHEN 3 THEN '3' WHEN 4 THEN '4' WHEN 5 THEN '5' WHEN 6 THEN '6' WHEN 7 THEN '7' WHEN 8 THEN '8' WHEN 9 THEN '9' WHEN 10 THEN 'A' WHEN 11 THEN 'B' WHEN 12 THEN 'C' WHEN 13 THEN 'D' WHEN 14 THEN 'E' WHEN 15 THEN 'F' END
	SET @R = @R - (@R / POWER(@B, 8)) * POWER(@B, 8)
	
	SELECT @H1 = CASE @R / POWER(@B, 4) WHEN 0 THEN '0' WHEN 1 THEN '1' WHEN 2 THEN '2' WHEN 3 THEN '3' WHEN 4 THEN '4' WHEN 5 THEN '5' WHEN 6 THEN '6' WHEN 7 THEN '7' WHEN 8 THEN '8' WHEN 9 THEN '9' WHEN 10 THEN 'A' WHEN 11 THEN 'B' WHEN 12 THEN 'C' WHEN 13 THEN 'D' WHEN 14 THEN 'E' WHEN 15 THEN 'F' END
	SET @R = @R - (@R / POWER(@B, 4)) * POWER(@B, 4)
	
	SELECT @H0 = CASE @R / POWER(@B, 0) WHEN 0 THEN '0' WHEN 1 THEN '1' WHEN 2 THEN '2' WHEN 3 THEN '3' WHEN 4 THEN '4' WHEN 5 THEN '5' WHEN 6 THEN '6' WHEN 7 THEN '7' WHEN 8 THEN '8' WHEN 9 THEN '9' WHEN 10 THEN 'A' WHEN 11 THEN 'B' WHEN 12 THEN 'C' WHEN 13 THEN 'D' WHEN 14 THEN 'E' WHEN 15 THEN 'F' END
	SET @R = @R - (@R / POWER(@B, 0)) * POWER(@B, 0)
	
	RETURN(@H1 + @H0 + @H3 + @H2 + @H5 + @H4 + @H7 + @H6)

END

